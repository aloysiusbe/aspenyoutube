<?php
/**
 * @file
 * The aspenyoutube module provides a block with aspen ideas youtube channel information via Jsn.
 */

/**
 * Implementation of hook_help().
 */
function aspenyoutube_help($path, $args) {
  if ($path == 'admin/help#aspenyoutube') {
    return t('To use this module, go to the block page and turn on the aspenyoutube block.');
  }
}
/**
 * Implements hook_block_info().
 */
function aspenyoutube_block_info() {
  $blocks = array();
  
  $blocks['aspenyoutube_one'] = array(
    'info' => t('Aspen Ideas Youtube New Videos'),
    'cache' => DRUPAL_NO_CACHE,);
  return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function aspenyoutube_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'aspenyoutube_one':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Aspen Ideas Youtube');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = array();
//Variable set-up.
$resultsAmounthardcode = 20;
$keyWord = 'aif12';
$developerKey = 'AIzaSyDEZospc4apgkPkoFL8LOM4QYIt3ugF-6Q';
$channelId = 'UCoiTVuiMdqBRMSBGMEcmxCw';
//Making the call to youtube data api and getting the Json contents using drupal http request and drupal_http_build_query.

$jsonData = file_get_contents("https://www.googleapis.com/youtube/v3/search?part=id%2Csnippet&channelId=".$channelId."&maxResults=".$resultsAmounthardcode."&q=".$keyWord."&key=".$developerKey);

//More Variable set-up and using Drupal Json_decode function to decode the url contents to parse.
$json = json_decode($jsonData, true);
$firstVideoNum = 0;
$secondVideoNum = 1;
$resultsAmount = (count($json['items']) -1);
$mainVideoId = $json['items'][$firstVideoNum]['id']['videoId'];
$mainTitle = $json['items'][$firstVideoNum]['snippet']['title'];
$mainTitle = preg_replace('/[^A-Za-z0-9 \?!]/', '', $mainTitle);
$mainDescrip = $json['items'][$firstVideoNum]['snippet']['description'];
$mainDescrip = preg_replace('/[^A-Za-z0-9 \?!]/', '', $mainDescrip)."...";
$postServer = htmlspecialchars($_SERVER["PHP_SELF"]);
//adding css for this module.
drupal_add_css(drupal_get_path('module', 'aspenyoutube') . '/default7.css', array('group' => CSS_DEFAULT, 'type' => 'file'));

//Static container div set up for mobile activated in css when screen is smaller.
$block['content'] ="<div id='newvideoStatic'>";
//Main Video container div set up.
$block['content'] .="<div id='newvideomainContainer'>";
$block['content'] .="<div class='newvideoContainer'><iframe id='mainvideo' name='mainvideo' src='//www.youtube.com/embed/$mainVideoId?rel=0' frameborder='0' allowfullscreen></iframe></div>";
//main title and description divs set up.
$block['content'] .="<div id='maintext'><h4>$mainTitle</h4><p>$mainDescrip</p></div>";
$block['content'] .="</div>";
$block['content'] .="</div>";

//Div set up for thumbnails.
$block['content'] .="<div id='newvideoThumbContent'>";
for ($i = $secondVideoNum; $i <= ($resultsAmount); $i++){

$vidId = $json['items'][$i]['id']['videoId'];
$title = $json['items'][$i]['snippet']['title'];
$title = preg_replace('/[^A-Za-z0-9 \?!]/', '', $title);
$titleCut = substr($title , 0, 100);
$descrip = $json['items'][$i]['snippet']['description'];
$descrip = preg_replace('/[^A-Za-z0-9 \?!]/', '', $descrip)."...";
$thumb = $json['items'][$i]['snippet']['thumbnails']['medium']['url'];

$block['content'] .="<div id='newvideoThumb'><a href='http://www.youtube.com/embed/$vidId?autoplay=1&amp;rel=0' target='mainvideo' onclick='document.getElementById(\"maintext\").innerHTML=\"<h2>$title</h2><p>$descrip</p>\"'><img id='newvideoThumbpic' src='$thumb' alt='Aspen Ideas Video' /></a><div id='newvideoThumbdesc'><h4>$title</h4><p>$descrip</p></div></div>";
}
$block['content'] .="</div>";
$block['content'] .="</div>";

  return $block;
     break;

    case 'example_empty':
      $block['subject'] = t('Title of second block (example_empty)');
      $block['content'] = '';
	    return $block;
      break;

  }

}



